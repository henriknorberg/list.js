var express = require('express');
var manager = require('./FileManager');
var cm = require('./CouchManager');
var re = require('./rendering');
var cfgManager = require('./configurationManager');
var fs = require('fs');

//load documents from ../html
var loader = new manager.DocumentLoader('../html');
loader.Load();

cfgManager.ConfigManager.ReadConfig('configure.json');

var cfg = cfgManager.ConfigManager.cfg;


//create couchdb interface
var client = new cm.Manager(cfg.couchDB.port, cfg.couchDB.host, cfg.couchDB.dbname);

//webserver
var app = express.createServer();

app.configure(function()
{
	app.use(express.bodyParser());
});

app.get('/', function(req, res)
{
	var index = loader.Files['index.html'];

	res.send(index.toString());
});

app.get('/GetLists', function(req ,res)
{
	client.GetLists(function(data)
	{
		var lists = [];
		for(var i = 0; i < data.length; i++)
		{
			lists[i] = data[i].listname;
		}
	
		res.send(lists);
	});
});

app.post('/NewList', function(req, res)
{
	var list = {
		listname : req.body.listname,
		schema : req.body.schema
	};
	
	client.NewList(list, function()
	{
		res.redirect('/');
	});
});

app.post('/Content', function(req, res)
{
	var listname = req.body.Name;
	
	client.GetListByName(listname, function(data)
	{
		res.send(data.schema.toString());
	});
});

app.get('/heading.gif', function(req, res)
{
	res.setHeader('Content-Type', 'image/gif');
	res.send(loader.Files['heading.gif']);
});

app.get('/style.css', function(req, res)
{
	res.setHeader('Content-Type', 'text/css');
	res.send(loader.Files['style.css']);
});

app.get('/custom.js', function(req, res)
{
	res.setHeader('Content-Type', 'text/javascript');
	res.send(loader.Files['custom.js']);
});

app.get('/jquery-1.5.1.js', function(req, res)
{
	res.setHeader('Content-Type', 'text/javascript');
	res.send(loader.Files['jquery-1.5.1.js']);
});

app.get('/jquery-ui-1.8.11.custom.min.js', function(req, res)
{
	res.setHeader('Content-Type', 'text/javascript');
	res.send(loader.Files['jquery-ui-1.8.11.custom.min.js']);
});

app.listen(8080);

console.log('Server listening @ 8080');
console.log()

